<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ  Home Chore Quest 2026</title>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --accent: #6c5ce7;
      --cat: #ffeaa7;
      --danger: #d63031;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 24px;
      color: #2d3436;
    }
    h1 { text-align: center; margin-bottom: 4px; }
    .subtitle { text-align: center; color: #636e72; margin-bottom: 20px; }
    .top-bar {
      display: flex; flex-wrap: wrap; gap: 12px;
      justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }
    select, button {
      padding: 8px 12px; border-radius: 8px;
      border: 1px solid #dfe6e9; background: white; cursor: pointer;
    }
    button.primary { background: var(--accent); color: white; border: none; }
    .calendar {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px;
    }
    .day {
      background: var(--card); border-radius: 16px; padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }
    .today { outline: 3px solid var(--accent); }
    .task { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.95rem; }
    .task input { margin-right: 8px; transform: scale(1.2); }
    .task small { margin-left: auto; color: #888; }
    .cat { background: var(--cat); border-radius: 12px; padding: 10px; margin-top: 12px; }
    .important { color: var(--danger); font-weight: 700; }
    .panel {
      margin-top: 32px; background: var(--card); border-radius: 16px;
      padding: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }
    footer { margin-top: 24px; text-align: center; font-size: 0.8rem; color: #999; }
  </style>
</head>
<body>
  <h1>ğŸ  Home Chore Quest Â· 2026</h1>
  <div class="subtitle">Weekly fairness Â· Monthly truth Â· Cat meds are sacred ğŸ±</div>

  <div class="panel" style="margin-top:16px;">
    <h3>ğŸ‘‹ How to use (Daily)</h3>
    <div style="font-size:0.95rem; line-height:1.6; color:#2d3436;">
      1ï¸âƒ£ Select <strong>your name</strong><br/>
      2ï¸âƒ£ Tick the tasks <strong>you personally completed</strong><br/>
      3ï¸âƒ£ Click <strong>ğŸ’¾ Save Todayâ€™s Records</strong> to record<br/>
      <br/>
      âœ” Only <strong>saved</strong> tasks count toward ranking<br/>
      âœ” You can change or undo ticks <strong>before saving</strong>
    </div>
  </div>

  <div class="panel" style="margin-top:12px;">
    <h3>ğŸ  House rules</h3>
    <div style="font-size:0.95rem; line-height:1.6; color:#2d3436;">
      â€¢ Please only tick tasks <strong>you actually did</strong><br/>
      â€¢ If a task was done together, agree before ticking<br/>
      â€¢ Try to update and save <strong>before going to bed</strong>
    </div>
  </div>

  <div class="top-bar">
    <div>ğŸ‘¤ Player: <select id="userSelect" onchange="render()"></select></div>
    <div>ğŸ“† View:
      <select id="periodSelect" onchange="render()">
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
    </div>
    <div id="weekPicker">â® Week: <select id="weekSelect" onchange="render()"></select></div>
    <div id="monthPicker" style="display:none;">ğŸ—“ Month: <select id="monthSelect" onchange="render()"></select></div>
    <div><button class="primary" onclick="goToday()">ğŸ“ Today</button></div>
  </div>

  <div class="calendar" id="calendar"></div>

  <div style="margin-top:16px; text-align:center;">
    <button class="primary" onclick="saveChanges()">ğŸ’¾ Save Todayâ€™s Records</button>
    <span id="saveStatus" style="margin-left:12px; color:#636e72;"></span>
  </div>

  <div class="panel">
    <h2 id="panelTitle">ğŸ† Ranking</h2>
    <div style="font-size:0.85rem; color:#636e72; margin-bottom:8px; line-height:1.4;">
      <strong>How points are calculated:</strong><br/>
      â€¢ Regular housework / cat tasks = <strong>1 point</strong> each<br/>
      â€¢ <strong>Cat medication (æ—©ä¸Š / å¤œæ™š)</strong> = <strong>3 points</strong> each (higher priority)<br/>
      â€¢ Only <strong>saved</strong> checkmarks count toward ranking<br/>
      â€¢ Unsaved changes are previews and do not affect scores
    </div>
    <div id="ranking"></div>
  </div>

  <footer>Calm system for a healthy home Â· Data over arguments Â· Built for 2026 âœ¨</footer>

<script>
/* ===== CONFIG ===== */
const YEAR = 2026;
const players = ["Dennis","Sharon","Robert"];
const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

const tasks = {
  general: [
    "ğŸ½ æ¸…æ´—ç¢—ç›¤ â†’ æ”¾å…¥æ´—ç¢—æ©Ÿ",
    "ğŸ½ æ´—ç¢—æ©Ÿå®Œæˆå¾Œ â†’ æ”¾å›ç¢—æ«ƒ",
    "ğŸ§º æ´—è¡£å¾Œ â†’ æ¸…ç†æ´—è¡£æ©Ÿ",
    "ğŸ§º ä¹¾è¡£å®Œæˆ â†’ å–èµ°è¡£ç‰©",
    "ğŸ‘• æ‘ºè¡«",
    "ğŸ§¹ å¸å¡µ",
    "ğŸ›‹ åŸ·å¥½æ¢³åŒ–",
    "ğŸª‘ åŸ·å¥½å…©å¼µæ±",
    "ğŸ³ æŠ¹çˆé ­",
    "ğŸ½ æŠ¹å»šæˆ¿æ±é¢",
    "ğŸ§Š æ¸…ç†é›ªæ«ƒéæœŸé£Ÿç‰©",
    "ğŸ—‘ å€’åƒåœ¾ï¼‹æ›è¢‹",
    "ğŸš½ æ¸…ç†å»æ‰€",
    "ğŸ“¦ æ¸…ç†å»šæˆ¿é›œç‰© â†’ æ”¾å›æ«ƒ"
  ],
  cat: [
    { name: "ğŸ’Š Cat Med â€“ æ—©ä¸Š é¤µè—¥", important: true },
    { name: "ğŸ’Š Cat Med â€“ å¤œæ™š é¤µè—¥", important: true },
    { name: "ğŸ± æ›æ°´ç¢—ï¼ˆæ¯ 2â€“3 æ—¥ä¸€æ¬¡ï¼‰" },
    { name: "ğŸ± æ´—ç³§é£Ÿå…œï¼ˆæ¯ 2â€“3 æ—¥ä¸€æ¬¡ï¼‰" },
    { name: "ğŸ± åŠ ç³§å…¥ç³§æ©Ÿ" },
    { name: "ğŸ± åŸ·å±ï¼‹æ¸…å±è¢‹" },
    { name: "ğŸ± åŸ·å°¿" },
    { name: "ğŸ± é™ªç© 10 åˆ†é˜" },
    { name: "ğŸ± ç–æ¯› 10 åˆ†é˜" },
    { name: "ğŸ± å‰ªæŒ‡ç”²" },
    { name: "ğŸ± æ²–æ¶¼" },
    { name: "ğŸš° æ¸…æ´—é£²æ°´æ©Ÿï¼‹æ› Filterï¼ˆæ¯æœˆ 15 è™Ÿï¼‰", important: true }
  ]
};

/* ===== DOM ===== */
const calendarEl = document.getElementById("calendar");
const rankingEl = document.getElementById("ranking");
const userSelect = document.getElementById("userSelect");
const periodSelect = document.getElementById("periodSelect");
const weekSelect = document.getElementById("weekSelect");
const weekPicker = document.getElementById("weekPicker");
const monthPicker = document.getElementById("monthPicker");
const monthSelect = document.getElementById("monthSelect");
const panelTitle = document.getElementById("panelTitle");

players.forEach(p => {
  const o = document.createElement('option');
  o.textContent = p;
  userSelect.appendChild(o);
});

let data = JSON.parse(localStorage.getItem("choreQuest2026")) || { weeks: {} };
let pendingChanges = {}; // buffer of unsaved edits per weekKey: { [taskKey]: string | null } (null = remove assignment)

/* ===== DATE HELPERS ===== */
function getWeekNumber(date = new Date()) {
  const oneJan = new Date(YEAR, 0, 1);
  return Math.ceil((((date - oneJan) / 86400000) + oneJan.getDay() + 1) / 7);
}
function getWeekKey(week) { return `${YEAR}-W${week}`; }
function getWeekDateRange(week) {
  const firstDay = new Date(YEAR, 0, 1);
  const start = new Date(YEAR, 0, 1 + (week - 1) * 7 - firstDay.getDay());
  const end = new Date(start); end.setDate(start.getDate() + 6);
  return { start, end };
}
function formatDate(d) { return `${d.getMonth() + 1}/${d.getDate()}`; }

/* ===== DATA ===== */
function getWeekData(weekKey) {
  if (!data.weeks[weekKey]) data.weeks[weekKey] = { completed: {} };
  return data.weeks[weekKey];
}

function normalizeUsers(val) {
  if (!val) return [];
  if (Array.isArray(val)) return val.filter(Boolean);
  if (typeof val === 'string') return [val];
  return [];
}
function getValidKeysSet() {
  const valid = new Set();
  days.forEach(day => {
    tasks.general.forEach(t => valid.add(day + t));
    tasks.cat.forEach(t => valid.add(day + t.name));
  });
  return valid;
}

function cleanupWeekData(weekKey) {
  const week = getWeekData(weekKey);
  const valid = getValidKeysSet();
  let changed = false;

  Object.keys(week.completed).forEach(k => {
    if (!valid.has(k)) {
      delete week.completed[k];
      changed = true;
      return;
    }

    const users = normalizeUsers(week.completed[k]);
    // keep only known players, unique
    const cleaned = Array.from(new Set(users.filter(u => players.includes(u))));

    if (cleaned.length === 0) {
      delete week.completed[k];
      changed = true;
    } else {
      // migrate old string format -> array format, and clean invalid entries
      if (!Array.isArray(week.completed[k]) || JSON.stringify(cleaned) !== JSON.stringify(week.completed[k])) {
        week.completed[k] = cleaned;
        changed = true;
      }
    }
  });

  if (changed) save();
  return week;
}

function isMedTaskKey(key) {
  return key.includes('Cat Med') || key.includes('é¤µè—¥');
}

function calculateScores(week) {
  const scores = { Dennis: 0, Sharon: 0, Robert: 0 };
  Object.entries(week.completed).forEach(([k, users]) => {
    if (!Array.isArray(users)) return;
    users.forEach(u => {
      if (!scores.hasOwnProperty(u)) return;
      scores[u] += isMedTaskKey(k) ? 3 : 1;
    });
  });
  return scores;
}
function save() {
  localStorage.setItem("choreQuest2026", JSON.stringify(data));
}

function hasPending(weekKey){
  return !!(pendingChanges[weekKey] && Object.keys(pendingChanges[weekKey]).length);
}

function updateSaveUI(){
  const weekKey = weekSelect.value;
  const btn = document.querySelector('button.primary[onclick="saveChanges()"]');
  if(!btn) return;
  btn.disabled = !hasPending(weekKey);
  btn.style.opacity = btn.disabled ? 0.55 : 1;
  document.getElementById('saveStatus').textContent = hasPending(weekKey) ? 'Unsaved changesâ€¦' : '';
}

function saveChanges() {
  const weekKey = weekSelect.value;
  if (!hasPending(weekKey)) {
    document.getElementById('saveStatus').textContent = 'Nothing to save';
    setTimeout(()=>document.getElementById('saveStatus').textContent='',1200);
    return;
  }

  const week = getWeekData(weekKey);
  Object.entries(pendingChanges[weekKey]).forEach(([k, v]) => {
    if (v === null) delete week.completed[k];
    else week.completed[k] = v;
  });

  delete pendingChanges[weekKey];
  save();

  document.getElementById('saveStatus').textContent = 'Saved âœ”';
  setTimeout(()=>document.getElementById('saveStatus').textContent='',1500);
  render();
}

/* ===== ACTIONS ===== */
function toggleTask(day, task) {
  if (periodSelect.value !== 'week') return;

  const user = userSelect.value;
  const weekKey = weekSelect.value;
  if (!pendingChanges[weekKey]) pendingChanges[weekKey] = {};

  // Build current visible state (base + pending) so toggling behaves like a real user expects
  const baseWeek = cleanupWeekData(weekKey);
  const current = { ...baseWeek.completed };
  Object.entries(pendingChanges[weekKey]).forEach(([k, v]) => {
    if (v === null) delete current[k];
    else current[k] = v;
  });

  const key = day + task;
  const assignedTo = normalizeUsers(current[key]);

  // Behavior:
  // - If unassigned -> assign to selected player
  // - If assigned to selected player -> unassign (set null)
  // - If assigned to someone else -> reassign to selected player
  if (!assignedTo.includes(user)) {
    pendingChanges[weekKey][key] = [...assignedTo, user];
  } else {
    const next = assignedTo.filter(u => u !== user);
    pendingChanges[weekKey][key] = next.length ? next : null;
  }

  // Remove no-op entries (if pending equals base)
  const baseAssigned = normalizeUsers(baseWeek.completed[key]);
  const pend = pendingChanges[weekKey][key];
  const pendUsers = (pend === null) ? [] : normalizeUsers(pend);
  if ((pend === null && baseAssigned.length === 0) || (pend !== null && JSON.stringify(pendUsers) === JSON.stringify(baseAssigned))) {
    delete pendingChanges[weekKey][key];
  }
  if (pendingChanges[weekKey] && Object.keys(pendingChanges[weekKey]).length === 0) {
    delete pendingChanges[weekKey];
  }

  render();
}

/* ===== RENDER ===== */
function render() {
  updateSaveUI();
  calendarEl.innerHTML = '';
  rankingEl.innerHTML = '';

  // Toggle pickers based on view
  const isWeek = periodSelect.value === 'week';
  weekPicker.style.display = isWeek ? '' : 'none';
  monthPicker.style.display = isWeek ? 'none' : '';

  if (isWeek) {
    const weekKey = weekSelect.value;
    const weekNum = parseInt(weekKey.split('-W')[1]);
    const range = getWeekDateRange(weekNum);
    const baseWeek = cleanupWeekData(weekKey);
    const week = { completed: { ...baseWeek.completed } };
    // Apply pending changes (including deletions)
    if (pendingChanges[weekKey]) {
      Object.entries(pendingChanges[weekKey]).forEach(([k, v]) => {
        if (v === null) delete week.completed[k];
        else week.completed[k] = v;
      });
    }
    // Weekly ranking: show SAVED scores, plus a clear PREVIEW if there are unsaved changes
    const savedScores = calculateScores(baseWeek);
    const previewScores = calculateScores(week);
    const hasUnsaved = hasPending(weekKey);
    const today = new Date().getDay();

    panelTitle.textContent = `ğŸ† Weekly Ranking Â· ${formatDate(range.start)} â€“ ${formatDate(range.end)}`;

    days.forEach((day, i) => {
      const card = document.createElement('div');
      card.className = 'day' + (i === today ? ' today' : '');
      card.innerHTML = `<h3>${day}</h3>`;

      tasks.general.forEach(t => {
        const k = day + t;
        const done = normalizeUsers(week.completed[k]);
        const checked = done.includes(userSelect.value);
        card.innerHTML += `<div class='task'>
          <input type='checkbox' ${checked ? 'checked' : ''} onchange="toggleTask('${day}','${t}')" />
          ${t}<small>${Array.isArray(done) ? done.join(', ') : ''}</small></div>`;
      });

      let catHtml = `<div class='cat'>`;
      tasks.cat.forEach(t => {
        const k = day + t.name;
        const done = normalizeUsers(week.completed[k]);
        const checked = done.includes(userSelect.value);
        catHtml += `<div class='task'>
          <input type='checkbox' ${checked ? 'checked' : ''} onchange="toggleTask('${day}','${t.name}')" />
          <span class='${t.important ? 'important' : ''}'>${t.name}</span>
          <small>${Array.isArray(done) ? done.join(', ') : ''}</small></div>`;
      });
      catHtml += `</div>`;
      card.innerHTML += catHtml;
      calendarEl.appendChild(card);
    });

    players.forEach(p => {
      const saved = savedScores[p];
      const preview = previewScores[p];
      const diff = preview - saved;
      const diffText = hasUnsaved && diff !== 0 ? ` <span style="color:#636e72; font-size:0.9rem;">(preview ${diff>0?'+':''}${diff} after Save)</span>` : '';
      rankingEl.innerHTML += `<div>${p}: <strong>${saved} pts</strong>${diffText}</div>`;
    });

    if (hasUnsaved) {
      rankingEl.innerHTML += `<div style="margin-top:10px; color:#636e72; font-size:0.85rem;">Tip: ranking is based on <strong>saved</strong> records. Click <strong>Save</strong> to make previews official.</div>`;
    }

  } else {
    const m = parseInt(monthSelect.value);
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    panelTitle.textContent = `ğŸ† Monthly Summary Â· ${monthNames[m]} ${YEAR}`;
    const currentMonth = parseInt(monthSelect.value);
    const monthStart = new Date(YEAR, currentMonth, 1);
    const monthEnd = new Date(YEAR, currentMonth + 1, 0, 23, 59, 59, 999);
    const totals = { Dennis: 0, Sharon: 0, Robert: 0 };
    const meds = { Dennis: 0, Sharon: 0, Robert: 0 };

    Object.entries(data.weeks).forEach(([wk, wdata]) => {
      // Ensure old data formats are migrated/cleaned before monthly totals
      wdata = cleanupWeekData(wk);
      const wkNum = parseInt(wk.split('-W')[1]);
      const range = getWeekDateRange(wkNum);
      // Include any week that overlaps the selected month
      if (range.end < monthStart || range.start > monthEnd) return;

      const scores = calculateScores(wdata);
      players.forEach(p => totals[p] += scores[p]);
      Object.entries(wdata.completed).forEach(([k, u]) => {
        if (!isMedTaskKey(k)) return;
        const users = normalizeUsers(u);
        users.forEach(p => { if (meds[p] !== undefined) meds[p]++; });
      });
    });

    players.forEach(p => {
      rankingEl.innerHTML += `<div>${p}: <strong>${totals[p]} pts</strong> Â· ğŸ± Meds: ${meds[p]}</div>`;
    });
  }
}

function goToday() {
  periodSelect.value = 'week';
  weekSelect.value = getWeekKey(getWeekNumber());
  render();
}

/* ===== INIT ===== */
function init() {
  // Month selector
  const monthNamesFull = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  monthSelect.innerHTML = '';
  for (let m = 0; m < 12; m++) {
    const o = document.createElement('option');
    o.value = String(m);
    o.textContent = monthNamesFull[m];
    monthSelect.appendChild(o);
  }
  // Default month: if current year matches, use current month; otherwise start at January
  const now = new Date();
  monthSelect.value = (now.getFullYear() === YEAR) ? String(now.getMonth()) : '0';

  const currentWeek = getWeekNumber();
  weekSelect.innerHTML = '';
  for (let i = 1; i <= 53; i++) {
    const range = getWeekDateRange(i);
    const o = document.createElement('option');
    o.value = getWeekKey(i);
    o.textContent = `Week ${i} (${formatDate(range.start)}â€“${formatDate(range.end)})`;
    if (i === currentWeek) o.selected = true;
    weekSelect.appendChild(o);
  }
  render();
}

// Warn users if they try to close/refresh with unsaved changes in the current week
window.addEventListener('beforeunload', (e) => {
  const wk = weekSelect.value;
  if (periodSelect.value === 'week' && hasPending(wk)) {
    e.preventDefault();
    e.returnValue = '';
  }
});

init();
</script>
</body>
</html>
